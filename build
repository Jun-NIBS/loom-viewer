#! /bin/bash
if [ -a ./static ]; then
  rm -r ./static
fi
set -o nounset
set -o errexit

DEBUGMODE="$@"

if [ "$DEBUGMODE" = "debug" ] || [ "$DEBUGMODE" = "-d" ]; then
  echo "Building React in 'debug' mode"
  export NODE_ENV=debug
else
  echo "Building React in 'production' mode. Run \"./build debug\" to build in 'debug' mode"
  export NODE_ENV=production
fi

# Current version
v=1

# Set up the static directory
mkdir static
mkdir static/img
mkdir static/css
mkdir static/js

# Build all the static assets
echo "Building static assets."
cp img/* static/img/
BINPATH=$(npm -g bin)
$BINPATH/uglifycss css/* > static/css/bundle-v$v.min.css
$BINPATH/browserify js/loom.js -o temp.js -t [ babelify --presets [ es2015 react ] ]
$BINPATH/uglifyjs js/jquery.min.js js/bootstrap.min.js temp.js -o static/js/bundle-v$v.min.js
rm temp.js

sed -e "s/{VERSION}/$v/g" index.html > static/index.html

# Build and deploy the containers
echo "Building docker containers."
docker build --no-cache -t gcr.io/linnarsson-lab/loom-server:v$v -f docker/loom-server.dockerfile .
docker build --no-cache -t gcr.io/linnarsson-lab/loom-pipeline:v$v -f docker/loom-pipeline.dockerfile .
echo "Pushing containers to cloud."
gcloud docker push gcr.io/linnarsson-lab/loom-server:v$v
gcloud docker push gcr.io/linnarsson-lab/loom-pipeline:v$v
echo "Done."
