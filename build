#! /bin/bash

# Remove old files
if [ -a ./python/loom_viewer/static/ ]; then
  rm -r ./python/loom_viewer/static/
fi

if [ -a ./python/build ]; then
  rm -r ./python/build
fi
if [ -a ./python/dist ]; then
  rm -r ./python/dist
fi

set -o nounset
set -o errexit


# Build static assets

if  [ "${1:-dev}" == "dev" ]; then
  echo "Bundling development build and inserting it into HTML template"
  webpack --config='webpack.config.dev.js' --progress --profile --colors
elif [ "${1:-dev}" == "prod" ]; then
  echo "Testing production. Minifying + bundling production build and inserting it into HTML template"
  webpack --config='webpack.config.testprod.js' --progress --profile --colors
elif [ "${1:-dev}" == "deploy" ]; then
  echo "Building for deployment. Minifying + bundling production build and inserting it into HTML template"
  webpack --config='webpack.config.deploy.js' --progress --profile --colors
else
  echo "Incorrect flags passed"
  exit 1
fi

build_status=$?

if [ $build_status == 0 ]; then

  echo "Building static assets."
  # I haven't figured out how to both generate correct paths in the webpack HTML
  # template, and have the resulting index.html be put in the right folders.
  # Yes, this is an ugly hack around my incompetence, but it works - Job
  mv ./python/loom_viewer/index.html ./python/loom_viewer/static/index.html

  cd python
  echo "Installing loom python package"
  python setup.py install --force
  cd ..
else
  echo "Minification not finished properly, aborting build"
  exit $build_status
fi