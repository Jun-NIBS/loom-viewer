#! /bin/bash
if [ -a ./python/static ]; then
  rm -r ./python/static
fi
set -o nounset
set -o errexit

DEBUGMODE="$@"

if [ "$DEBUGMODE" = "debug" ] || [ "$DEBUGMODE" = "-d" ]; then
  echo "Building React in 'debug' mode"
  export NODE_ENV=debug
else
  echo "Building React in 'production' mode. Run \"./build debug\" to build in 'debug' mode"
  export NODE_ENV=production
fi

# Current version
v=1

# Set up the static directory
mkdir ./python/static
mkdir ./python/static/img
mkdir ./python/static/css
mkdir ./python/static/js

# Build all the static assets
echo "Building static assets."
cp img/* ./python/static/img/
BINPATH=$(npm -g bin)
$BINPATH/uglifycss css/* > ./python/static/css/bundle-v$v.min.css
$BINPATH/browserify js/loom.js -o temp.js -t [ babelify --presets [ es2015 react ] ]

if [ "$DEBUGMODE" = "debug" ] || [ "$DEBUGMODE" = "-d" ]; then
  $BINPATH/uglifyjs -b -nm -ns -v js/jquery.min.js js/bootstrap.min.js temp.js -o ./python/static/js/bundle-v$v.min.js
else
  $BINPATH/uglifyjs js/jquery.min.js js/bootstrap.min.js temp.js -o ./python/static/js/bundle-v$v.min.js
fi
rm temp.js

sed -e "s/{VERSION}/$v/g" index.html > ./python/static/index.html

