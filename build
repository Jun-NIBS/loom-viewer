#! /bin/bash
if [ -a ./release/cache ]; then
  echo "Saving cache folder from previous build."
  mv ./release/cache ./cache
fi
rm -r ./release
set -o nounset
set -o errexit
export NODE_ENV=production  # To use DEBUG mode, just comment out this line
echo "Building React in 'production' mode (for debug mode, edit this build script)."

# Set up a cache-busting integer
v=$RANDOM

# Set up the release directories
mkdir release
if [ -a ./cache ]; then
    echo "Restoring cache folder from previous build."
  mv ./cache ./release/cache
fi
mkdir release/python
mkdir release/python/static
mkdir release/python/static/img
mkdir release/python/static/css
mkdir release/python/static/js
cp img/* release/python/static/img/
cp -r python release/
cp loom release/loom

# Build all the static assets
BINPATH=$(npm -g bin)
$BINPATH/uglifycss css/* > release/python/static/css/bundle-v$v.min.css
$BINPATH/browserify js/loom.js -o temp.js -t [ babelify --presets [ es2015 react ] ]
$BINPATH/uglifyjs js/jquery.min.js js/bootstrap.min.js temp.js -o release/python/static/js/bundle-v$v.min.js
rm temp.js

sed -e "s/{VERSION}/$v/g" index.html > release/python/static/index.html
