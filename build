#! /bin/bash

# Remove old files
if [ -a ./python/loom_viewer/static/js ]; then
  rm -r ./python/loom_viewer/static/js
fi
if [ -a ./python/loom_viewer/static/css ]; then
  rm -r ./python/loom_viewer/static/css
fi
if [ -a ./python/build ]; then
  rm -r ./python/build
fi
if [ -a ./python/dist ]; then
  rm -r ./python/dist
fi

set -o nounset
set -o errexit

# Set up the static directory
mkdir ./python/loom_viewer/static/js
mkdir ./python/loom_viewer/static/css

# Build static assets

if  [ "${1:-dev}" == "dev" ]; then
  echo "Bundling development build and inserting it into HTML template"
  webpack --config='webpack.config.dev.js' --progress --profile --colors
else
  echo "Minifying + bundling production build and inserting it into HTML template"
  webpack --config='webpack.config.prod.js' --progress --profile --colors
fi

echo "Building static assets."
uglifycss ./client/css/*.css > ./python/loom_viewer/static/css/bundle.min.css
# I can't figure out how to both generate correct paths in the HTML template
# of webpack, and have the resulting index.html be put in the right folders.
# Yes, it's an ugly hack, but it works - Job
mv ./python/loom_viewer/index.html ./python/loom_viewer/static/index.html
cp -R ./client/fonts ./python/loom_viewer/static/

cd python
echo "Installing loom python package"
python setup.py install --force
cd ..