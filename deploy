#! /bin/bash

echo ""
echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
echo "!! Don't forget to update _version.py before deploying !!"
echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
echo ""
./build prod
build_status=$?
if [ $build_status == 0 ]; then
  cd python
  echo ""
  echo "============================================================"
  echo "                   Submitting to PyPi"
  echo " (Did you remember to update _version.py before deploying?)"
  echo "============================================================"
  echo ""
  python setup.py sdist upload -r pypi
  cd ..
  echo ""
  echo "*** NOT upgrading the server. Please wait a few minutes (to ensure that"
  echo "    PyPi has serves the most recent loompy version), then upgrade"
  echo "    manually as follows:"
  echo ""
  echo "- SSH into the server:    gcloud compute ssh ubuntu@loom --zone \"us-central1-a\""
  echo "- Upgrade Loom:           upgrade_loom"
  echo ""
else
  echo "Build not finished properly, aborting upload to pypi"
  exit $build_status
fi